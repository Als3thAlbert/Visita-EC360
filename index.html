<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Alta Visita ‚Äì E-CONSULTING 360</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--naranja:#ff6600;--negro:#111;--gris:#555;--bg:#fafafa;--radius:8px;--fuente:15px/1.4 -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);font:var(--fuente);color:var(--negro);padding:1rem;padding-bottom:80px}
header{text-align:center;margin-bottom:1.5rem}
.logo{font-size:1.8rem;font-weight:bold;color:var(--naranja);text-shadow:1px 1px 3px rgba(0,0,0,.25)}
h2{margin:1rem 0 .5rem;color:var(--naranja)}
form{display:grid;gap:.75rem}
label{font-weight:600;color:var(--gris)}
input,select,textarea,button{width:100%;padding:.65rem;font-size:1rem;border:1px solid #ddd;border-radius:var(--radius)}
textarea{resize:vertical;min-height:70px}
button{position:fixed;bottom:0;left:0;right:0;padding:1rem;font-size:1.1rem;font-weight:600;border:0;background:var(--naranja);color:#fff;cursor:pointer;box-shadow:0 -2px 8px rgba(0,0,0,.15);z-index:10}
button:active{opacity:.9}
#ticket{background:#fff;padding:1.2rem;border-radius:var(--radius);margin-top:1rem;box-shadow:0 2px 10px rgba(0,0,0,.08)}
#ticket .logo{font-size:1.4rem;font-weight:bold;color:var(--naranja);text-shadow:1px 1px 3px rgba(0,0,0,.25);margin-bottom:.6rem}
#ticket p{margin:.25rem 0}
.hidden{display:none}
.divider{height:1px;background:#ddd;margin:.6rem 0}

/* POP-UP */
#popupOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:200;display:none;align-items:center;justify-content:center}
#popupBox{background:#fff;padding:1.5rem;border-radius:var(--radius);width:90%;max-width:350px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,.25)}
#popupBox h3{color:var(--naranja);margin-bottom:.5rem}
#popupBox p{margin:.5rem 0}
#popupBtnWhatsApp{margin-top:1rem;background:#25D366;color:#fff;border:0;padding:.75rem 1rem;border-radius:var(--radius);font-size:1rem;cursor:pointer}
#popupBtnWhatsApp:active{opacity:.9}
</style>
</head>
<body>

<header>
  <div class="logo">E-CONSULTING 360</div>
  <h2>Alta Visita</h2>
</header>

<form id="forma" autocomplete="off">
  <label>Call Center *</label>
  <select name="call_center" required>
    <option value="">-- Selecciona --</option>
    <option>Jennifer Diana</option>
    <option>Marina</option>
  </select>

  <label>Observaciones</label>
  <textarea name="observaciones"></textarea>

  <label>Contacto (Gerente) *</label>
  <input name="contacto" required>

  <label>Tel√©fono *</label>
  <input name="telefono" type="tel" required>

  <label>Direcci√≥n *</label>
  <input name="direccion" required>

  <label>Poblaci√≥n *</label>
  <input name="poblacion" required>

  <label>Fecha de Visita *</label>
  <input name="fecha_visita" type="date" required>

  <label>Hora *</label>
  <input name="hora" type="time" required>

  <label>Local / Establecimiento</label>
  <input name="local">

  <label>Comarca</label>
  <input name="comarca">

  <label>Comercializadora</label>
  <input name="comercializadora">

  <label>Comentarios Asesor</label>
  <textarea name="comentarios_asesor"></textarea>

  <label>CRM (opcional)</label>
  <input name="crm">
</form>

<!-- PREVIEW (solo campos del ticket) -->
<div id="ticket" class="hidden">
  <div class="logo">E-CONSULTING 360</div>
  <p><strong>Call Center:</strong> <span id="pv_call_center"></span></p>
  <p><strong>Observaciones:</strong> <span id="pv_observaciones"></span></p>
  <p><strong>Contacto:</strong> <span id="pv_contacto"></span></p>
  <p><strong>Tel√©fono:</strong> <span id="pv_telefono"></span></p>
  <p><strong>Direcci√≥n:</strong> <span id="pv_direccion"></span></p>
  <p><strong>Poblaci√≥n:</strong> <span id="pv_poblacion"></span></p>
  <p><strong>Fecha Visita:</strong> <span id="pv_fecha_visita"></span></p>
  <p><strong>Hora:</strong> <span id="pv_hora"></span></p>
  <p><strong>Timestamp:</strong> <span id="pv_timestamp"></span></p>
</div>

<button type="submit" form="forma">Generar JPG y subir a Drive</button>

<!-- POP-UP -->
<div id="popupOverlay" class="hidden">
  <div id="popupBox">
    <h3>‚úÖ Se gener√≥ correctamente</h3>
    <p>La imagen se est√° subiendo a la carpeta‚Ä¶</p>
    <button id="popupBtnWhatsApp">üì§ Exportar imagen a WhatsApp</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
// Fecha de llamada = hoy (se env√≠a al backend)
document.addEventListener('DOMContentLoaded', () => {
  const hoy = new Date();
  // No mostramos fecha de llamada al usuario, solo la usamos internamente
});

forma.addEventListener('submit', async e => {
  e.preventDefault();
  const d = Object.fromEntries(new FormData(forma));

  // Rellena preview (solo campos del ticket)
  ['call_center','observaciones','contacto','telefono','direccion','poblacion','fecha_visita','hora'].forEach(k => {
    const el = document.getElementById('pv_' + k);
    if(el) el.textContent = d[k] || '';
  });
  // Timestamp autom√°tico
  document.getElementById('pv_timestamp').textContent = new Date().toLocaleString('es-ES');

  ticket.classList.remove('hidden');

  // Genera JPG
  const canvas = await html2canvas(ticket, {scale:3,backgroundColor:'#fff'});
  canvas.toBlob(async blob => {
    const reader = new FileReader();
    reader.readAsDataURL(blob);
    reader.onloadend = async () => {
      const base64 = reader.result.split(',')[1];

      // Guardamos en Sheets (con TODOS los campos, pero solo los 9 del ticket aparecen en el JPG)
      const payload = {
        ...d,
        fecha_llamada: new Date().toISOString().slice(0,10), // hoy
        jpg_url: '', // se llenar√° despu√©s
        timestamp: new Date().toISOString()
      };
      await fetch('https://script.google.com/macros/s/AKfycbyXSH1HentT_0gysgH9haoyEzNdg8Pd7_TIno8UiN2ahjG77ugLq9EF-cXThYtlmUDsYQ/exec', {
        method: 'POST',
        body: JSON.stringify(payload)
      });

      // MOSTRAR POP-UP
      mostrarPopUp(blob);
    };
  });
});

// Funci√≥n para mostrar pop-up y manejar WhatsApp
function mostrarPopUp(blob) {
  const overlay = document.getElementById('popupOverlay');
  const btnWhatsApp = document.getElementById('popupBtnWhatsApp');
  overlay.classList.remove('hidden');

  // Al pulsar el bot√≥n del pop-up
  btnWhatsApp.onclick = async () => {
    const file = new File([blob], 'visita.jpg', {type:'image/jpeg'});
    if (navigator.share) {
      await navigator.share({title:'Comprobante',files:[file]});
    } else {
      // Fallback: abre WhatsApp Web con texto predefinido
      const text = encodeURIComponent('Aqu√≠ tienes el comprobante de tu visita:');
      const url = URL.createObjectURL(blob);
      window.open(`https://wa.me/?text=${text}&media=${url}`, '_blank');
    }
    overlay.classList.add('hidden');
  };
}
</script>
</body>
</html>
