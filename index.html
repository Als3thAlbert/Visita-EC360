const SHEET_ID = '1XpSuE9wzhEQ0pM9AxtzE4WtFz8eQpMtlKYYDMvNOs3s';
const FOLDER_ID = '1K447O80SunH-ykKx61E9LAmtqA9K-9QE';

function doPost(e) {
  const p = JSON.parse(e.postData.contents);

  // Subir JPG a Drive
  const blob = Utilities.newBlob(Utilities.base64Decode(p.jpg), 'image/jpeg', 'visita.jpg');
  const file = DriveApp.getFolderById(FOLDER_ID).createFile(blob);
  file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

  const sheet = SpreadsheetApp.openById(SHEET_ID).getActiveSheet();

  // Alineado exacto con tus columnas
  sheet.appendRow([
    p.call_center || '',          // CALL CENTER
    p.observaciones || '',        // OBSERVACIONES
    p.si_no || 'NO',              // SI / NO
    p.fecha_llamada || '',        // FECHA LLAMADA
    p.local || '',                // LOCAL
    p.contacto || '',             // CONTACTO
    p.telefono || '',             // TELEFONO
    p.direccion || '',            // DIRECCIÃ“N
    p.poblacion || '',            // POBLACION
    p.comarca || '',              // COMARCA
    p.fecha_visita || '',         // FECHA DE VISITA
    p.hora || '',                 // HORA
    p.comercializadora || '',     // COMERCIALIZADORA
    p.call_center || '',          // ASESOR (igual que CALL CENTER)
    p.comentarios || '',          // COMENTARIOS
    p.comentarios_asesor || '',   // COMENTARIOS ASESOR
    p.crm || '',                  // CRM
    file.getUrl(),                // jpg_url
    new Date()                    // Timestamp
  ]);

  return ContentService.createTextOutput(JSON.stringify({ url: file.getUrl() }))
                       .setMimeType(ContentService.MimeType.JSON);
}
