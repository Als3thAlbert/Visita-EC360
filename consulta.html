<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Consulta de Visitas ‚Äì E-CONSULTING 360</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--naranja:#ff6600;--negro:#111;--gris:#555;--bg:#fafafa;--radius:8px;--fuente:15px/1.4 -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);font:var(--fuente);color:var(--negro);padding:1rem}
header{text-align:center;margin-bottom:1.5rem}
.logo{font-size:1.8rem;font-weight:bold;color:var(--naranja);text-shadow:1px 1px 3px rgba(0,0,0,.25)}
h2{margin:1rem 0 .5rem;color:var(--naranja)}
form{display:grid;gap:.75rem}
label{font-weight:600;color:var(--gris)}
input,select,button{width:100%;padding:.65rem;font-size:1rem;border:1px solid #ddd;border-radius:var(--radius)}
button{background:var(--naranja);color:#fff;border:0;cursor:pointer}
button:active{opacity:.9}
.actions{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem}
#lista{background:#fff;padding:1rem;border-radius:var(--radius);margin-top:1rem;box-shadow:0 2px 8px rgba(0,0,0,.08)}
#lista p{margin:.25rem 0}
.divider{height:1px;background:#ddd;margin:.5rem 0}
#log{background:#f0f0f0;border-left:4px solid var(--naranja);padding:.5rem;margin-top:1rem;font-size:.85rem;color:#444;white-space:pre-wrap}
.fila-debug{font-size:.75rem;color:#666;margin-bottom:.3rem}
</style>
</head>
<body>

<header>
  <div class="logo">E-CONSULTING 360</div>
  <h2>Consulta de Visitas</h2>
</header>

<form id="filtro">
  <label>Asesor</label>
  <select id="asesor">
    <option value="">-- Todos --</option>
    <option>Jennifer Diana</option>
    <option>Marina</option>
    <option>Eli</option>
    <option>I√±igo</option>
    <option>Merche</option>
    <option>N√∫ria</option>
    <option>Jenny AC</option>
    <option>Tere</option>
    <option>Ray</option>
  </select>

  <label>Desde</label>
  <input type="date" id="desde" required>

  <label>Hasta</label>
  <input type="date" id="hasta" required>

  <button type="submit">Filtrar visitas</button>
</form>

<div class="actions">
  <button onclick="window.open('https://drive.google.com/drive/folders/1K447O80SunH-ykKx61E9LAmtqA9K-9QE?usp=sharing','_blank')">üìÅ Ver JPGs en Drive</button>
  <button onclick="window.open('https://docs.google.com/spreadsheets/d/1XpSuE9wzhEQ0pM9AxtzE4WtFz8eQpMtlKYYDMvNOs3s/edit?usp=sharing','_blank')">üìä Ver Excel completo</button>
</div>

<div id="log"></div>
<div id="lista"></div>

<script>
// CONFIGURA TUS IDs
const SHEET_ID = '1XpSuE9wzhEQ0pM9AxtzE4WtFz8eQpMtlKYYDMvNOs3s';

// Fechas por defecto (hoy y hace 15 d√≠as)
const hoy = new Date();
const hace15 = new Date(hoy); hace15.setDate(hoy.getDate() - 15);
document.getElementById('desde').value = hace15.toISOString().slice(0, 10);
document.getElementById('hasta').value = hoy.toISOString().slice(0, 10);

// Cargar y filtrar visitas
document.getElementById('filtro').addEventListener('submit', async e => {
  e.preventDefault();
  const asesorSel = document.getElementById('asesor').value;
  const desde = new Date(document.getElementById('desde').value);
  const hasta = new Date(document.getElementById('hasta').value);
  hasta.setHours(23, 59, 59, 999);

  const log = document.getElementById('log');
  const lista = document.getElementById('lista');
  log.textContent = '‚è≥ Cargando datos...\n';
  lista.innerHTML = '';

  try {
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&headers=1`;
    const res = await fetch(url);
    const text = await res.text();
    log.textContent += '‚úÖ Respuesta obtenida\n';

    const json = JSON.parse(text.substr(47).slice(0, -2));
    const rows = json.table.rows;
    log.textContent += `üìä Total de filas: ${rows.length}\n`;

    let html = '';
    let contador = 0;

    rows.forEach((r, idx) => {
      // columna F ‚Üí "2026-01-22 12:00"
      const fechaStr = (r.c[5]?.v || '').toString().trim();
      const asesor   = (r.c[2]?.v || '').trim();
      const jpgUrl   = r.c[8]?.v || '';

      // depuraci√≥n visible por fila
      const logFila = `Fila ${idx + 1}: asesor="${aseser}" fechaStr="${fechaStr}"`;

      if (!fechaStr || fechaStr.length < 10) {
        log.innerHTML += `<div class="fila-debug">‚ö†Ô∏è Salto: fecha vac√≠a (${logFila})</div>`;
        return;
      }

      const [dia, hora] = fechaStr.split(' ');
      if (!dia || !hora) {
        log.innerHTML += `<div class="fila-debug">‚ö†Ô∏è Salto: formato fecha mal (${logFila})</div>`;
        return;
      }

      const [y, m, d] = dia.split('-');
      const [h, min]  = hora.split(':');
      const fechaVisita = new Date(y, m - 1, d, h, min);

      // depuraci√≥n de fecha convertida
      log.innerHTML += `<div class="fila-debug">‚úÖ Fecha convertida: ${fechaVisita.toLocaleString('es-ES')} (${logFila})</div>`;

      if (
        fechaVisita >= desde &&
        fechaVisita <= hasta &&
        (asesorSel === '' || asesor === asesorSel)
      ) {
        contador++;
        html += `
          <p><strong>${r.c[1]?.v || ''}</strong> (${asesor})</p>
          <p>${r.c[4]?.v || ''} ¬∑ ${fechaVisita.toLocaleString('es-ES')}</p>
          <p><a href="${jpgUrl}" target="_blank">üìé Ver JPG</a></p>
          <div class="divider"></div>
        `;
      }
    });

    log.textContent += `‚úÖ Filtradas: ${contador} visitas\n`;
    document.getElementById('lista').innerHTML = html || '<p>Sin visitas en este rango.</p>';

  } catch (err) {
    log.textContent += '‚ùå Error: ' + err.message + '\n';
    document.getElementById('lista').innerHTML = '<p>Error al cargar datos.</p>';
  }
});
</script>
</body>
</html>
